<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qy.member.app.infrastructure.persistence.mybatis.mapper.MemberSystemMapper">

    <select id="selectByAccountId" resultType="com.qy.member.app.application.dto.MemberOrganizationBasicDTO">
        SELECT auoo.id organization_id, auoo.name organization_name, auoo.short_name
        FROM ark_uims_org_organization auoo
        WHERE auoo.is_deleted = 0
          AND auoo.id IN
              (SELECT amm.organization_id FROM ark_mbr_member amm WHERE
               amm.account_id = #{accountId} and amm.system_id = #{systemId}
         AND amm.is_deleted = 0 and amm.status_id = 1 and amm.audit_status_id in (1,3))
    </select>

    <select id="selectByQuery" resultType="com.qy.member.app.infrastructure.persistence.mybatis.dataobject.MemberSystemDO">
        SELECT
            amms.*,
            auoo.`name` AS organization_name,
            CASE WHEN ammso.organization_id = amms.organization_id THEN 1 ELSE 0 END AS is_create_organization
        FROM
            ark_mbr_member_system_organization ammso
                LEFT JOIN ark_mbr_member_system amms ON amms.id = ammso.system_id
                LEFT JOIN ark_uims_org_organization auoo ON auoo.id = ammso.organization_id
        <where>
            amms.is_deleted = 0
            <if test="query.organizationId == null">
                and 1=0
            </if>
            <if test="query.keywords != null and query.keywords != ''">
                and (amms.name like concat('%', #{query.keywords}, '%')
            </if>
            <if test="query.statusId != null">
                and amms.status_id = #{query.statusId}
            </if>
            <if test="query.organizationId != null">
                and ammso.organization_id = #{query.organizationId}
            </if>
        </where>
        order by ammso.create_time
    </select>
</mapper>
